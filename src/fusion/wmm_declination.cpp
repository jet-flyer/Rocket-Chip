// WMM magnetic declination lookup with bilinear interpolation.
// See wmm_declination.h for data source and accuracy notes.

#include "fusion/wmm_declination.h"

#include <cmath>
#include <cstdint>

namespace rc {

// Grid parameters — 10° resolution, matching ArduPilot AP_Declination.
static constexpr int32_t kLatRows = 19;        // -90 to +90 in 10° steps
static constexpr int32_t kLonCols = 37;        // -180 to +180 in 10° steps
static constexpr float kGridResF = 10.0F;
static constexpr float kMinLat = -90.0F;
static constexpr float kMaxLat = 90.0F;
static constexpr float kMinLon = -180.0F;
static constexpr float kMaxLon = 180.0F;

// Degrees-to-radians conversion.
static constexpr float kDegToRad = 3.14159265F / 180.0F;

// Declination table: degrees.
// 19 rows (lat -90 to +90, 10° steps) × 37 cols (lon -180 to +180, 10° steps).
// Source: ArduPilot AP_Declination/tables.cpp (IGRF13 epoch, auto-generated).
// Table size: 2,812 bytes.
// NOLINTBEGIN(readability-magic-numbers)
static constexpr float kDeclinationTable[19][37] = {
    { 148.83402F, 138.83401F, 128.83401F, 118.83402F, 108.83402F, 98.83402F, 88.83402F, 78.83402F, 68.83402F, 58.83402F, 48.83402F, 38.83402F, 28.83402F, 18.83402F, 8.83402F, -1.16598F, -11.16598F, -21.16598F, -31.16598F, -41.16598F, -51.16598F, -61.16598F, -71.16598F, -81.16598F, -91.16598F, -101.16598F, -111.16598F, -121.16598F, -131.16598F, -141.16598F, -151.16598F, -161.16598F, -171.16598F, 178.83402F, 168.83402F, 158.83402F, 148.83402F },
    { 129.09306F, 116.89412F, 105.78898F, 95.63017F, 86.23504F, 77.42476F, 69.04348F, 60.96591F, 53.09841F, 45.37592F, 37.75568F, 30.20867F, 22.70998F, 15.23027F, 7.73037F, 0.16098F, -7.53238F, -15.40109F, -23.48496F, -31.80703F, -40.37375F, -49.18062F, -58.22152F, -67.49946F, -77.03640F, -86.88079F, -97.11212F, -107.84156F, -119.20626F, -131.35191F, -144.39481F, -158.35719F, -173.08769F, 171.78274F, 156.78187F, 142.43310F, 129.09306F },
    { 85.81367F, 77.83602F, 71.40003F, 65.88433F, 60.88263F, 56.08204F, 51.22755F, 46.12774F, 40.67419F, 34.85457F, 28.74909F, 22.50583F, 16.29363F, 10.23812F, 4.36029F, -1.45095F, -7.40778F, -13.74178F, -20.61213F, -28.04922F, -35.95530F, -44.15322F, -52.45486F, -60.71951F, -68.88732F, -76.99183F, -85.16746F, -93.67473F, -102.97950F, -113.96429F, -128.46293F, -150.36073F, 175.55488F, 138.00554F, 112.28051F, 96.48319F, 85.81367F },
    { 48.22805F, 46.81921F, 45.24300F, 43.71189F, 42.27245F, 40.80022F, 39.00177F, 36.49549F, 32.95972F, 28.26545F, 22.54379F, 16.18846F, 9.77818F, 3.88971F, -1.16066F, -5.50500F, -9.68832F, -14.40052F, -20.13990F, -26.99385F, -34.63319F, -42.50584F, -50.08478F, -57.00760F, -63.07978F, -68.20773F, -72.30336F, -75.14845F, -76.14220F, -73.56875F, -61.46573F, -19.66028F, 28.39616F, 43.98783F, 48.35027F, 49.03265F, 48.22805F },
    { 31.42931F, 31.60530F, 31.28145F, 30.79047F, 30.38024F, 30.16777F, 29.97487F, 29.25597F, 27.27948F, 23.46202F, 17.66378F, 10.37176F, 2.68673F, -4.06559F, -9.01317F, -12.19989F, -14.47861F, -17.04830F, -21.00672F, -26.83158F, -33.98769F, -41.32654F, -47.85214F, -52.97945F, -56.36644F, -57.72068F, -56.62201F, -52.29959F, -43.64045F, -30.08348F, -13.41611F, 2.35315F, 14.41455F, 22.53506F, 27.54777F, 30.28028F, 31.42931F },
    { 22.67985F, 23.21169F, 23.25494F, 22.99742F, 22.63545F, 22.42369F, 22.46877F, 22.43187F, 21.42571F, 18.33186F, 12.46440F, 4.21692F, -4.75068F, -12.30560F, -17.22721F, -19.74039F, -20.77499F, -21.16946F, -22.14607F, -25.39336F, -31.01102F, -37.19196F, -42.26227F, -45.34969F, -45.95366F, -43.77299F, -38.67388F, -30.72261F, -20.87969F, -11.16390F, -2.84711F, 4.17466F, 10.15622F, 15.07307F, 18.83144F, 21.33469F, 22.67985F },
    { 17.07334F, 17.59062F, 17.77934F, 17.69577F, 17.34929F, 16.88674F, 16.56217F, 16.38656F, 15.63204F, 12.86517F, 6.93562F, -1.75751F, -10.98436F, -18.20308F, -22.41588F, -24.27993F, -24.67590F, -23.50719F, -21.00605F, -19.72369F, -21.87960F, -26.21214F, -30.23195F, -32.25069F, -31.49417F, -28.07385F, -22.58093F, -15.67611F, -8.73630F, -3.38117F, 0.43868F, 3.90117F, 7.49078F, 10.92679F, 13.85484F, 15.93237F, 17.07334F },
    { 13.37426F, 13.67217F, 13.78744F, 13.78998F, 13.54222F, 12.98780F, 12.38852F, 11.96065F, 11.09372F, 8.25499F, 2.21162F, -6.34723F, -14.82596F, -20.89032F, -23.89434F, -24.45752F, -23.26867F, -20.14461F, -15.21492F, -10.62227F, -9.09952F, -11.18829F, -14.91638F, -17.58833F, -17.75073F, -15.65321F, -12.03643F, -7.38772F, -2.92537F, -0.15156F, 1.30857F, 3.04660F, 5.56513F, 8.30463F, 10.76538F, 12.51642F, 13.37426F },
    { 11.10969F, 11.11944F, 11.01236F, 10.99728F, 10.84097F, 10.32286F, 9.70494F, 9.19687F, 8.09157F, 4.94277F, -1.12864F, -9.05484F, -16.32980F, -21.04376F, -22.55109F, -21.19496F, -17.89373F, -13.44411F, -8.58084F, -4.24867F, -1.62827F, -1.86509F, -4.55045F, -7.42469F, -8.64775F, -8.12536F, -6.32716F, -3.48850F, -0.64489F, 0.72027F, 0.97976F, 1.90952F, 4.01623F, 6.51266F, 8.80749F, 10.44185F, 11.10969F },
    { 9.88349F, 9.72040F, 9.41289F, 9.38439F, 9.33291F, 8.89921F, 8.31537F, 7.68011F, 6.17272F, 2.60695F, -3.33977F, -10.37899F, -16.38823F, -19.72660F, -19.70115F, -16.80477F, -12.41185F, -7.91607F, -4.15177F, -1.10381F, 1.22204F, 1.82879F, 0.23517F, -2.13784F, -3.62813F, -3.94630F, -3.34494F, -1.85961F, -0.22644F, 0.26762F, -0.08803F, 0.44077F, 2.38763F, 4.89878F, 7.32401F, 9.15291F, 9.88349F },
    { 9.12464F, 9.18177F, 8.94457F, 9.04553F, 9.19618F, 8.89744F, 8.21223F, 7.14260F, 4.96349F, 0.86055F, -4.97931F, -11.14357F, -15.85640F, -17.78532F, -16.57645F, -13.08478F, -8.67898F, -4.59243F, -1.60427F, 0.55144F, 2.39028F, 3.23916F, 2.31654F, 0.46434F, -0.91732F, -1.53003F, -1.62589F, -1.18564F, -0.62403F, -0.86624F, -1.66562F, -1.50145F, 0.21812F, 2.79294F, 5.56329F, 7.91823F, 9.12464F },
    { 8.06290F, 8.93172F, 9.29767F, 9.81684F, 10.30693F, 10.20311F, 9.30721F, 7.53634F, 4.41412F, -0.45099F, -6.41113F, -11.85029F, -15.25565F, -15.88209F, -13.96742F, -10.49677F, -6.46933F, -2.75504F, -0.08743F, 1.66921F, 3.12874F, 3.96903F, 3.45981F, 2.05876F, 0.88578F, 0.20951F, -0.29117F, -0.68669F, -1.18101F, -2.27487F, -3.63054F, -3.95562F, -2.62221F, -0.08793F, 3.01927F, 6.01454F, 8.06290F },
    { 6.31041F, 8.41617F, 9.93058F, 11.21483F, 12.13996F, 12.23034F, 11.14011F, 8.66524F, 4.49928F, -1.34733F, -7.71989F, -12.71272F, -15.08305F, -14.75641F, -12.45343F, -9.09705F, -5.35725F, -1.83470F, 0.82823F, 2.57001F, 3.86519F, 4.69588F, 4.60243F, 3.76104F, 2.87601F, 2.13967F, 1.24833F, 0.02788F, -1.62859F, -3.80231F, -5.90990F, -6.79346F, -5.87079F, -3.45535F, -0.15720F, 3.34006F, 6.31041F },
    { 4.26294F, 7.59975F, 10.43666F, 12.70491F, 14.16020F, 14.43398F, 13.18770F, 10.10768F, 4.90586F, -2.08386F, -9.15208F, -14.09196F, -15.93051F, -15.08268F, -12.51517F, -9.09089F, -5.35759F, -1.77919F, 1.14514F, 3.24292F, 4.77489F, 5.90082F, 6.46683F, 6.42854F, 5.95440F, 5.04613F, 3.49019F, 1.14215F, -1.96091F, -5.46021F, -8.43365F, -9.79880F, -9.13330F, -6.77311F, -3.34752F, 0.50970F, 4.26294F },
    { 2.57464F, 6.81988F, 10.72127F, 13.95370F, 16.10049F, 16.72460F, 15.39548F, 11.64478F, 5.15172F, -3.36781F, -11.49173F, -16.72206F, -18.40831F, -17.31430F, -14.50140F, -10.79977F, -6.74992F, -2.76545F, 0.78143F, 3.70100F, 6.08013F, 8.07892F, 9.67963F, 10.67456F, 10.77058F, 9.65347F, 7.07600F, 3.02043F, -2.09809F, -7.27683F, -11.16806F, -12.81861F, -12.13043F, -9.62141F, -5.97603F, -1.77704F, 2.57464F },
    { 1.43503F, 6.27921F, 10.88019F, 14.88261F, 17.80063F, 19.02158F, 17.77297F, 13.12636F, 4.53718F, -6.54055F, -16.27050F, -21.85552F, -23.31365F, -21.85455F, -18.61101F, -14.36797F, -9.64057F, -4.79964F, -0.13239F, 4.18385F, 8.10605F, 11.64519F, 14.70734F, 16.97990F, 17.92977F, 16.88820F, 13.23164F, 6.81146F, -1.34665F, -8.97876F, -14.01257F, -15.81005F, -14.85926F, -12.00033F, -7.99733F, -3.40265F, 1.43502F },
    { 0.13094F, 5.45479F, 10.54962F, 15.08235F, 18.55436F, 20.17754F, 18.67574F, 12.20150F, -0.36226F, -15.49225F, -26.46004F, -31.19380F, -31.33251F, -28.66356F, -24.33699F, -19.03627F, -13.18344F, -7.06335F, -0.88475F, 5.19490F, 11.05071F, 16.55252F, 21.50321F, 25.56424F, 28.16988F, 28.41286F, 24.95220F, 16.43585F, 3.63861F, -8.67079F, -16.18909F, -18.69045F, -17.68753F, -14.54612F, -10.18137F, -5.16795F, 0.13094F },
    { -4.14830F, 1.12345F, 5.96040F, 9.84415F, 11.94596F, 10.80871F, 4.02869F, -10.36405F, -27.94912F, -39.79617F, -44.16477F, -43.57950F, -40.12657F, -34.99189F, -28.83083F, -22.02403F, -14.80922F, -7.34799F, 0.23881F, 7.85050F, 15.39197F, 22.75942F, 29.82156F, 36.38924F, 42.15868F, 46.59144F, 48.63821F, 46.09967F, 34.72041F, 12.13936F, -8.98865F, -18.65098F, -20.47841F, -18.40133F, -14.39834F, -9.45818F, -4.14830F },
    { -169.79948F, -159.79948F, -149.79948F, -139.79948F, -129.79948F, -119.79948F, -109.79948F, -99.79948F, -89.79948F, -79.79948F, -69.79948F, -59.79948F, -49.79948F, -39.79948F, -29.79948F, -19.79948F, -9.79948F, 0.20052F, 10.20052F, 20.20052F, 30.20052F, 40.20052F, 50.20052F, 60.20052F, 70.20052F, 80.20052F, 90.20052F, 100.20052F, 110.20052F, 120.20052F, 130.20052F, 140.20052F, 150.20052F, 160.20052F, 170.20052F, -179.79948F, -169.79948F },
};
// NOLINTEND(readability-magic-numbers)

float wmm_get_declination(float latDeg, float lonDeg) {
    // Clamp inputs to valid range
    if (latDeg < kMinLat) { latDeg = kMinLat; }
    if (latDeg > kMaxLat) { latDeg = kMaxLat; }
    if (lonDeg < kMinLon) { lonDeg = kMinLon; }
    if (lonDeg > kMaxLon) { lonDeg = kMaxLon; }

    // Convert to fractional grid indices
    float latIdx = (latDeg - kMinLat) / kGridResF;
    float lonIdx = (lonDeg - kMinLon) / kGridResF;

    // Integer grid corners (clamp to avoid out-of-bounds)
    int32_t latI = static_cast<int32_t>(latIdx);
    int32_t lonI = static_cast<int32_t>(lonIdx);
    if (latI >= kLatRows - 1) { latI = kLatRows - 2; }
    if (lonI >= kLonCols - 1) { lonI = kLonCols - 2; }

    // Fractional parts for interpolation
    float latFrac = latIdx - static_cast<float>(latI);
    float lonFrac = lonIdx - static_cast<float>(lonI);

    // Bilinear interpolation on four corners (degrees)
    float d00 = kDeclinationTable[latI][lonI];
    float d01 = kDeclinationTable[latI][lonI + 1];
    float d10 = kDeclinationTable[latI + 1][lonI];
    float d11 = kDeclinationTable[latI + 1][lonI + 1];

    float d0 = d00 + (d01 - d00) * lonFrac;  // top edge
    float d1 = d10 + (d11 - d10) * lonFrac;  // bottom edge
    float declDeg = d0 + (d1 - d0) * latFrac;

    // Convert degrees → radians
    return declDeg * kDegToRad;
}

} // namespace rc
