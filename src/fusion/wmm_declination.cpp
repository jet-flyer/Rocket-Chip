// WMM magnetic declination lookup with bilinear interpolation.
// See wmm_declination.h for data source and accuracy notes.

#include "fusion/wmm_declination.h"

#include <cmath>
#include <cstdint>

namespace rc {

// Grid parameters — 10° resolution, matching ArduPilot AP_Declination.
static constexpr int32_t kLatRows = 19;        // -90 to +90 in 10° steps
static constexpr int32_t kLonCols = 37;        // -180 to +180 in 10° steps
static constexpr float kGridResF = 10.0f;
static constexpr float kMinLat = -90.0f;
static constexpr float kMaxLat = 90.0f;
static constexpr float kMinLon = -180.0f;
static constexpr float kMaxLon = 180.0f;

// Degrees-to-radians conversion.
static constexpr float kDegToRad = 3.14159265f / 180.0f;

// Declination table: degrees.
// 19 rows (lat -90 to +90, 10° steps) × 37 cols (lon -180 to +180, 10° steps).
// Source: ArduPilot AP_Declination/tables.cpp (IGRF13 epoch, auto-generated).
// Table size: 2,812 bytes.
// NOLINTBEGIN(readability-magic-numbers)
static constexpr float kDeclinationTable[19][37] = {
    { 148.83402f, 138.83401f, 128.83401f, 118.83402f, 108.83402f, 98.83402f, 88.83402f, 78.83402f, 68.83402f, 58.83402f, 48.83402f, 38.83402f, 28.83402f, 18.83402f, 8.83402f, -1.16598f, -11.16598f, -21.16598f, -31.16598f, -41.16598f, -51.16598f, -61.16598f, -71.16598f, -81.16598f, -91.16598f, -101.16598f, -111.16598f, -121.16598f, -131.16598f, -141.16598f, -151.16598f, -161.16598f, -171.16598f, 178.83402f, 168.83402f, 158.83402f, 148.83402f },
    { 129.09306f, 116.89412f, 105.78898f, 95.63017f, 86.23504f, 77.42476f, 69.04348f, 60.96591f, 53.09841f, 45.37592f, 37.75568f, 30.20867f, 22.70998f, 15.23027f, 7.73037f, 0.16098f, -7.53238f, -15.40109f, -23.48496f, -31.80703f, -40.37375f, -49.18062f, -58.22152f, -67.49946f, -77.03640f, -86.88079f, -97.11212f, -107.84156f, -119.20626f, -131.35191f, -144.39481f, -158.35719f, -173.08769f, 171.78274f, 156.78187f, 142.43310f, 129.09306f },
    { 85.81367f, 77.83602f, 71.40003f, 65.88433f, 60.88263f, 56.08204f, 51.22755f, 46.12774f, 40.67419f, 34.85457f, 28.74909f, 22.50583f, 16.29363f, 10.23812f, 4.36029f, -1.45095f, -7.40778f, -13.74178f, -20.61213f, -28.04922f, -35.95530f, -44.15322f, -52.45486f, -60.71951f, -68.88732f, -76.99183f, -85.16746f, -93.67473f, -102.97950f, -113.96429f, -128.46293f, -150.36073f, 175.55488f, 138.00554f, 112.28051f, 96.48319f, 85.81367f },
    { 48.22805f, 46.81921f, 45.24300f, 43.71189f, 42.27245f, 40.80022f, 39.00177f, 36.49549f, 32.95972f, 28.26545f, 22.54379f, 16.18846f, 9.77818f, 3.88971f, -1.16066f, -5.50500f, -9.68832f, -14.40052f, -20.13990f, -26.99385f, -34.63319f, -42.50584f, -50.08478f, -57.00760f, -63.07978f, -68.20773f, -72.30336f, -75.14845f, -76.14220f, -73.56875f, -61.46573f, -19.66028f, 28.39616f, 43.98783f, 48.35027f, 49.03265f, 48.22805f },
    { 31.42931f, 31.60530f, 31.28145f, 30.79047f, 30.38024f, 30.16777f, 29.97487f, 29.25597f, 27.27948f, 23.46202f, 17.66378f, 10.37176f, 2.68673f, -4.06559f, -9.01317f, -12.19989f, -14.47861f, -17.04830f, -21.00672f, -26.83158f, -33.98769f, -41.32654f, -47.85214f, -52.97945f, -56.36644f, -57.72068f, -56.62201f, -52.29959f, -43.64045f, -30.08348f, -13.41611f, 2.35315f, 14.41455f, 22.53506f, 27.54777f, 30.28028f, 31.42931f },
    { 22.67985f, 23.21169f, 23.25494f, 22.99742f, 22.63545f, 22.42369f, 22.46877f, 22.43187f, 21.42571f, 18.33186f, 12.46440f, 4.21692f, -4.75068f, -12.30560f, -17.22721f, -19.74039f, -20.77499f, -21.16946f, -22.14607f, -25.39336f, -31.01102f, -37.19196f, -42.26227f, -45.34969f, -45.95366f, -43.77299f, -38.67388f, -30.72261f, -20.87969f, -11.16390f, -2.84711f, 4.17466f, 10.15622f, 15.07307f, 18.83144f, 21.33469f, 22.67985f },
    { 17.07334f, 17.59062f, 17.77934f, 17.69577f, 17.34929f, 16.88674f, 16.56217f, 16.38656f, 15.63204f, 12.86517f, 6.93562f, -1.75751f, -10.98436f, -18.20308f, -22.41588f, -24.27993f, -24.67590f, -23.50719f, -21.00605f, -19.72369f, -21.87960f, -26.21214f, -30.23195f, -32.25069f, -31.49417f, -28.07385f, -22.58093f, -15.67611f, -8.73630f, -3.38117f, 0.43868f, 3.90117f, 7.49078f, 10.92679f, 13.85484f, 15.93237f, 17.07334f },
    { 13.37426f, 13.67217f, 13.78744f, 13.78998f, 13.54222f, 12.98780f, 12.38852f, 11.96065f, 11.09372f, 8.25499f, 2.21162f, -6.34723f, -14.82596f, -20.89032f, -23.89434f, -24.45752f, -23.26867f, -20.14461f, -15.21492f, -10.62227f, -9.09952f, -11.18829f, -14.91638f, -17.58833f, -17.75073f, -15.65321f, -12.03643f, -7.38772f, -2.92537f, -0.15156f, 1.30857f, 3.04660f, 5.56513f, 8.30463f, 10.76538f, 12.51642f, 13.37426f },
    { 11.10969f, 11.11944f, 11.01236f, 10.99728f, 10.84097f, 10.32286f, 9.70494f, 9.19687f, 8.09157f, 4.94277f, -1.12864f, -9.05484f, -16.32980f, -21.04376f, -22.55109f, -21.19496f, -17.89373f, -13.44411f, -8.58084f, -4.24867f, -1.62827f, -1.86509f, -4.55045f, -7.42469f, -8.64775f, -8.12536f, -6.32716f, -3.48850f, -0.64489f, 0.72027f, 0.97976f, 1.90952f, 4.01623f, 6.51266f, 8.80749f, 10.44185f, 11.10969f },
    { 9.88349f, 9.72040f, 9.41289f, 9.38439f, 9.33291f, 8.89921f, 8.31537f, 7.68011f, 6.17272f, 2.60695f, -3.33977f, -10.37899f, -16.38823f, -19.72660f, -19.70115f, -16.80477f, -12.41185f, -7.91607f, -4.15177f, -1.10381f, 1.22204f, 1.82879f, 0.23517f, -2.13784f, -3.62813f, -3.94630f, -3.34494f, -1.85961f, -0.22644f, 0.26762f, -0.08803f, 0.44077f, 2.38763f, 4.89878f, 7.32401f, 9.15291f, 9.88349f },
    { 9.12464f, 9.18177f, 8.94457f, 9.04553f, 9.19618f, 8.89744f, 8.21223f, 7.14260f, 4.96349f, 0.86055f, -4.97931f, -11.14357f, -15.85640f, -17.78532f, -16.57645f, -13.08478f, -8.67898f, -4.59243f, -1.60427f, 0.55144f, 2.39028f, 3.23916f, 2.31654f, 0.46434f, -0.91732f, -1.53003f, -1.62589f, -1.18564f, -0.62403f, -0.86624f, -1.66562f, -1.50145f, 0.21812f, 2.79294f, 5.56329f, 7.91823f, 9.12464f },
    { 8.06290f, 8.93172f, 9.29767f, 9.81684f, 10.30693f, 10.20311f, 9.30721f, 7.53634f, 4.41412f, -0.45099f, -6.41113f, -11.85029f, -15.25565f, -15.88209f, -13.96742f, -10.49677f, -6.46933f, -2.75504f, -0.08743f, 1.66921f, 3.12874f, 3.96903f, 3.45981f, 2.05876f, 0.88578f, 0.20951f, -0.29117f, -0.68669f, -1.18101f, -2.27487f, -3.63054f, -3.95562f, -2.62221f, -0.08793f, 3.01927f, 6.01454f, 8.06290f },
    { 6.31041f, 8.41617f, 9.93058f, 11.21483f, 12.13996f, 12.23034f, 11.14011f, 8.66524f, 4.49928f, -1.34733f, -7.71989f, -12.71272f, -15.08305f, -14.75641f, -12.45343f, -9.09705f, -5.35725f, -1.83470f, 0.82823f, 2.57001f, 3.86519f, 4.69588f, 4.60243f, 3.76104f, 2.87601f, 2.13967f, 1.24833f, 0.02788f, -1.62859f, -3.80231f, -5.90990f, -6.79346f, -5.87079f, -3.45535f, -0.15720f, 3.34006f, 6.31041f },
    { 4.26294f, 7.59975f, 10.43666f, 12.70491f, 14.16020f, 14.43398f, 13.18770f, 10.10768f, 4.90586f, -2.08386f, -9.15208f, -14.09196f, -15.93051f, -15.08268f, -12.51517f, -9.09089f, -5.35759f, -1.77919f, 1.14514f, 3.24292f, 4.77489f, 5.90082f, 6.46683f, 6.42854f, 5.95440f, 5.04613f, 3.49019f, 1.14215f, -1.96091f, -5.46021f, -8.43365f, -9.79880f, -9.13330f, -6.77311f, -3.34752f, 0.50970f, 4.26294f },
    { 2.57464f, 6.81988f, 10.72127f, 13.95370f, 16.10049f, 16.72460f, 15.39548f, 11.64478f, 5.15172f, -3.36781f, -11.49173f, -16.72206f, -18.40831f, -17.31430f, -14.50140f, -10.79977f, -6.74992f, -2.76545f, 0.78143f, 3.70100f, 6.08013f, 8.07892f, 9.67963f, 10.67456f, 10.77058f, 9.65347f, 7.07600f, 3.02043f, -2.09809f, -7.27683f, -11.16806f, -12.81861f, -12.13043f, -9.62141f, -5.97603f, -1.77704f, 2.57464f },
    { 1.43503f, 6.27921f, 10.88019f, 14.88261f, 17.80063f, 19.02158f, 17.77297f, 13.12636f, 4.53718f, -6.54055f, -16.27050f, -21.85552f, -23.31365f, -21.85455f, -18.61101f, -14.36797f, -9.64057f, -4.79964f, -0.13239f, 4.18385f, 8.10605f, 11.64519f, 14.70734f, 16.97990f, 17.92977f, 16.88820f, 13.23164f, 6.81146f, -1.34665f, -8.97876f, -14.01257f, -15.81005f, -14.85926f, -12.00033f, -7.99733f, -3.40265f, 1.43502f },
    { 0.13094f, 5.45479f, 10.54962f, 15.08235f, 18.55436f, 20.17754f, 18.67574f, 12.20150f, -0.36226f, -15.49225f, -26.46004f, -31.19380f, -31.33251f, -28.66356f, -24.33699f, -19.03627f, -13.18344f, -7.06335f, -0.88475f, 5.19490f, 11.05071f, 16.55252f, 21.50321f, 25.56424f, 28.16988f, 28.41286f, 24.95220f, 16.43585f, 3.63861f, -8.67079f, -16.18909f, -18.69045f, -17.68753f, -14.54612f, -10.18137f, -5.16795f, 0.13094f },
    { -4.14830f, 1.12345f, 5.96040f, 9.84415f, 11.94596f, 10.80871f, 4.02869f, -10.36405f, -27.94912f, -39.79617f, -44.16477f, -43.57950f, -40.12657f, -34.99189f, -28.83083f, -22.02403f, -14.80922f, -7.34799f, 0.23881f, 7.85050f, 15.39197f, 22.75942f, 29.82156f, 36.38924f, 42.15868f, 46.59144f, 48.63821f, 46.09967f, 34.72041f, 12.13936f, -8.98865f, -18.65098f, -20.47841f, -18.40133f, -14.39834f, -9.45818f, -4.14830f },
    { -169.79948f, -159.79948f, -149.79948f, -139.79948f, -129.79948f, -119.79948f, -109.79948f, -99.79948f, -89.79948f, -79.79948f, -69.79948f, -59.79948f, -49.79948f, -39.79948f, -29.79948f, -19.79948f, -9.79948f, 0.20052f, 10.20052f, 20.20052f, 30.20052f, 40.20052f, 50.20052f, 60.20052f, 70.20052f, 80.20052f, 90.20052f, 100.20052f, 110.20052f, 120.20052f, 130.20052f, 140.20052f, 150.20052f, 160.20052f, 170.20052f, -179.79948f, -169.79948f },
};
// NOLINTEND(readability-magic-numbers)

float wmm_get_declination(float lat_deg, float lon_deg) {
    // Clamp inputs to valid range
    if (lat_deg < kMinLat) { lat_deg = kMinLat; }
    if (lat_deg > kMaxLat) { lat_deg = kMaxLat; }
    if (lon_deg < kMinLon) { lon_deg = kMinLon; }
    if (lon_deg > kMaxLon) { lon_deg = kMaxLon; }

    // Convert to fractional grid indices
    float lat_idx = (lat_deg - kMinLat) / kGridResF;
    float lon_idx = (lon_deg - kMinLon) / kGridResF;

    // Integer grid corners (clamp to avoid out-of-bounds)
    int32_t lat_i = static_cast<int32_t>(lat_idx);
    int32_t lon_i = static_cast<int32_t>(lon_idx);
    if (lat_i >= kLatRows - 1) { lat_i = kLatRows - 2; }
    if (lon_i >= kLonCols - 1) { lon_i = kLonCols - 2; }

    // Fractional parts for interpolation
    float lat_frac = lat_idx - static_cast<float>(lat_i);
    float lon_frac = lon_idx - static_cast<float>(lon_i);

    // Bilinear interpolation on four corners (degrees)
    float d00 = kDeclinationTable[lat_i][lon_i];
    float d01 = kDeclinationTable[lat_i][lon_i + 1];
    float d10 = kDeclinationTable[lat_i + 1][lon_i];
    float d11 = kDeclinationTable[lat_i + 1][lon_i + 1];

    float d0 = d00 + (d01 - d00) * lon_frac;  // top edge
    float d1 = d10 + (d11 - d10) * lon_frac;  // bottom edge
    float decl_deg = d0 + (d1 - d0) * lat_frac;

    // Convert degrees → radians
    return decl_deg * kDegToRad;
}

} // namespace rc
